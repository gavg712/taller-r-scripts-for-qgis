---
title: "2. Tu primera herramienta"
author: "Gabo Gaona & Antony Barja"
date: 2022-06-20T07:00:00-05:00
tags: ["R","QGIS"]
---

<script src="{{< blogdown/postref >}}index.es_files/kePrint/kePrint.js"></script>
<link href="{{< blogdown/postref >}}index.es_files/lightable/lightable.css" rel="stylesheet" />


<div id="introducci√≥n" class="section level3">
<h3>Introducci√≥n</h3>
<p>Un script R para <em>Processing R Provider</em> no es diferente que un script normal de R. Las peque√±as diferencias entre ambos son simplemente estructuras l√≥gicas para que el complemento en QGIS pueda interpretarlos correctamente. A continuaci√≥n se listan las particularidades de los R scripts para QGIS:</p>
<ul>
<li>Tienen la extensi√≥n <code>.rsx</code> y pueden estar acompa√±ados de un fichero de ayuda de extensi√≥n <code>.rsx.help</code>.</li>
<li>Tienen por lo menos dos secciones importantes, un encabezado y un cuerpo, que se repasan en un secci√≥n posterior.</li>
<li>Tanto el <code>.rsx</code> como el <code>.rsx.help</code> deben estar en un directorio predefinido en la configuraci√≥n del complemento.</li>
</ul>
<p>Todas las instrucciones de R que se escriban en el script ser√°n internamente reescritas en un Rscript (<code>.r</code>|<code>.R</code>) temporal que ser√° ejecutado en la consola de R.</p>
</div>
<div id="estructura-de-un-script" class="section level3">
<h3>Estructura de un script</h3>
<p>Un script R para <em>processing</em> tiene dos partes principales. Un <strong>encabezado</strong> que contiene la configuraci√≥n de la herramienta; y un <strong>cuerpo</strong> que contiene el c√≥digo R que ejecutar√° el proceso. El ejemplo que estudiaremos a continuaci√≥n es tomado de los scripts incorporados en la instalaci√≥n del complemento <em>Processing R provider</em>.</p>
<pre class="r"><code>##Example scripts=group
##Scatterplot=name
##Layer=vector
##X=Field Layer
##Y=Field Layer
##output_plots_to_html

# simple scatterplot
plot(Layer[[X]], Layer[[Y]])</code></pre>
<p>Las l√≠neas que empiezan con doble signo numeral (<code>##</code>) conforman el encabezado del script. Por ejemplo: <code>##Layer=vector</code>. Debe diferenciarse las l√≠neas de encabezado (<code>##</code>) y de las l√≠neas de comentarios (<code>#</code>) de modo que no causen confusi√≥n al algoritmo de <em>Processing R Prvider</em>. En tal caso, para los comentarios se recomienda usar un solo signo numeral <code>#</code> cuando este empieza en una l√≠nea nueva: Por ejemplo <code># simple scatterplot</code>.</p>
<p>Las l√≠neas de encabezado ser√°n internamente convertidas en instrucciones de distintos tipos para que funcionen correctamente como una herramienta. Estas l√≠neas condicionar√°n la estructura de la interfaz de la herramienta y el comportamiento de la misma.</p>
<p>Una l√≠nea de encabezado est√° conformada por dos partes: Identificador y Tipo.</p>
<pre class="r"><code>##nombre_parametro=tipo [valor_por_defecto/desde_variable]</code></pre>
<p>‚Ä¶del script anterior podemos tomar cualquiera de las cinco primeras l√≠neas como ejemplo, y veremos que tiene la estructura mencionada. Sin embargo algunos par√°metros del encabezado pueden estar conformados simplemente por una etiqueta (por ejemplo <code>##output_plots_to_html</code>) que se usan internamente para indicar comportamientos espec√≠ficos de la herramienta. M√°s detalles se ver√° en una secci√≥n posterior.</p>
<p>Los comentarios y las dem√°s instrucciones de R no forman parte del encabezado, por lo tanto ser√°n consideradas como cuerpo del script. Estas l√≠neas ser√°n transcritas a un Rscript temporal, que ser√° ejecutado l√≠nea por l√≠nea en la consola de R, mediante un subproceso stdin/stdout.</p>
</div>
<div id="tipos-de-par√°metros" class="section level3">
<h3>Tipos de par√°metros</h3>
<p>El encabezado puede contener distintos tipos de par√°metros. Y de acuerdo con ellos la herramienta se comportar√° de una forma u otra:</p>
<div id="metadatos" class="section level4">
<h4>Metadatos</h4>
<p>Son par√°metros que permiten organizar el script en el √≠ndice de processing. Entre ellos tenemos:</p>
<ul>
<li><code>name</code> Permite definir un nombre corto para el script</li>
<li><code>display_name</code> Permite definir un nombre largo para el script. Este se mostrar√° en el √≠ndice y en la barra de t√≠tulo de la herramienta</li>
<li><code>group</code> nombre del grupo al que pertenece el script. Permite organizar la nueva herramienta como parte de un grupo espec√≠fico de herramientas.</li>
</ul>
<pre class="r"><code>##Example scripts=group
##Scatterplot=name
##Scatterplot from selected fields=display_name</code></pre>
</div>
<div id="par√°metros-de-comportamiento" class="section level4">
<h4>Par√°metros de comportamiento</h4>
<p>Sirven para definir el comportamiento general del script. Estos par√°metros se configuran en el encabezado, pero el usuario no interact√∫a con estos. Entre ellos tenemos</p>
<ul>
<li><code>load_raster_using_rgdal</code></li>
<li><code>load_vector_using_rgdal</code></li>
<li><code>pass_filenames</code></li>
<li><code>dont_load_any_packages</code></li>
<li><code>github_install</code></li>
<li><code>expression</code></li>
<li><code>output_plots_to_html</code></li>
</ul>
</div>
<div id="par√°metros-de-entrada" class="section level4">
<h4>Par√°metros de entrada</h4>
<p>Estas l√≠neas de par√°metros especifican la apariencia de la interfaz del script. A partir de la estructura b√°sica <code>##nombre_parametro=tipo [valor_por_defecto/desde_variable]</code> podemos destacar que <code>nombre_par√°metro</code> ser√° el nombre del objeto que contenga esa variable en la sesi√≥n de R. Mientras que <code>tipo</code> ser√° el tipo de datos de entrada, de los posibles tipos de entrada (vector, raster, table, number, string, boolean, Field).</p>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
<span id="tab:unnamed-chunk-3">Table 1: </span>Par√°metros y referencias a otros par√°metros
</caption>
<thead>
<tr>
<th style="text-align:left;">
Par√°metro
</th>
<th style="text-align:left;">
Valor por defecto
</th>
<th style="text-align:left;">
Desde variable
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
<code>vector</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>raster</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>table</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>number</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>string</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>boolean</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>Field</code>
</td>
<td style="text-align:left;">
No
</td>
<td style="text-align:left;">
definida en <code>vector</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>color</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>range</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>datetime</code>
</td>
<td style="text-align:left;">
Si
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>Band</code>
</td>
<td style="text-align:left;">
No
</td>
<td style="text-align:left;">
definida en <code>raster</code>
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>extent</code>
</td>
<td style="text-align:left;">
No
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>crs</code>
</td>
<td style="text-align:left;">
No
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>enum</code>
</td>
<td style="text-align:left;">
No
</td>
<td style="text-align:left;">
No
</td>
</tr>
<tr>
<td style="text-align:left;">
<code>enum literal</code>
</td>
<td style="text-align:left;">
No
</td>
<td style="text-align:left;">
No
</td>
</tr>
</tbody>
</table>
</div>
<div id="par√°metros-de-salida" class="section level4">
<h4>Par√°metros de salida</h4>
<p>Se trata de l√≠neas que permiten definir el tipo de resultado que tendr√° el script. Visualmente estos par√°metros generan interfaces gr√°ficas para guardar ficheros, mientras que internamente se traducen como instrucciones para escribir objetos R como ficheros.</p>
<p>La especificaci√≥n de estos par√°metros es la siguiente:</p>
<pre class="r"><code>##&lt;Nombre_de_salida&gt; =output &lt;tipo&gt;</code></pre>
<p>Entre las salidas posibles tenemos las siguientes:</p>
<ul>
<li>Salidas de capas: <code>vector</code>, <code>raster</code>, <code>table</code></li>
<li>Salidas de valores: <code>string</code> <code>number</code></li>
<li>Directorios y ficheros: <code>folder</code> y <code>file</code>. El el caso de file, se puede especificar una extensi√≥n para el fichero de salida. Por ejemplo <code>csv</code>.</li>
</ul>
{{% notice "tip" "üëå Tip!" %}}
Opcionalmente se puede usar la palabra clave `noprompt` al final de cada par√°metro de salida, para especificar que no genere el widget en la interfaz de la herramienta.
{{% /notice %}}
</div>
</div>
<div id="ejercicio" class="section level3">
<h3>Ejercicio</h3>
<p>Imagina que tienes un campo de valores num√©ricos en una capa de vectores. Y necesitas obtener un gr√°fico que combine un violin y boxplot juntos, para visualizar la distribuci√≥n de los datos. Y tus datos est√°n cargados en la sesi√≥n de QGIS.</p>
<p>El ejercicio consiste en hacer una herramienta para QGIS que haga el gr√°fico a partir de un campo seleccionado de una capa espec√≠fica.</p>
<p>Tiempo de intentarlo, t√≥mate un tiempo de 3 minutos para analizar el siguiente c√≥digo de R.</p>
<pre class="r"><code>library(ggplot2)
&lt;Transformador&gt; &lt;- c(&quot;boxcox&quot;, &quot;exp&quot;, &quot;log&quot;, &quot;log10&quot;, &quot;log1p&quot;, &quot;log2&quot;, 
               &quot;logit&quot;, &quot;probability&quot;, &quot;probit&quot;, &quot;pseudo_log&quot;, &quot;reciprocal&quot;, 
               &quot;reverse&quot;, &quot;sqrt&quot;)[&lt;Transformador&gt;]
p &lt;- &lt;objeto sf&gt; |&gt; 
    ggplot() +
    geom_violin(aes_string(x = 0, y = &lt;campo del objeto sf&gt;), 
                alpha = 0.3, fill = &quot;blue&quot;, width = 0.5) +
    geom_boxplot(aes_string(y = &lt;campo del objeto sf&gt;), 
                 alpha = 0.5, fill = &quot;red&quot;, width = 0.1)

if(!is.null(&lt;Transformador&gt;)) {
    p &lt;- p + 
         scale_y_continuous(trans = &lt;Transformador&gt;) +
         labs(y = glue::glue(&quot;{&lt;campo del objeto sf&gt;} [{&lt;Transformador&gt;}]&quot;)) 
}
p</code></pre>
<p>Cuando est√©s listo:</p>
<ul>
<li>Crea un nuevo script para QGIS Processing desde <img src="processing-r-icon.png" alt=":inline" /><code>/Create New R Script</code>.</li>
<li>Escribe el encabezado de tu script para QGIS Processing, bas√°ndote en el c√≥digo de R que revisaste
<ul>
<li>Empieza asignando un nombre al script con el par√°metro <code>name</code></li>
<li>Agrega un grupo al script con el par√°metro <code>group</code></li>
<li>Agrega un par√°metro para una capa vectorial usando el par√°metro <code>vector</code></li>
<li>Agrega un par√°metro para campo desde la capa vectorial, mediante el par√°metro <code>Field</code> y vinc√∫lalo a la capa vector agregando el nombre de la variable que asignaste en el par√°metro anterior.</li>
<li>Agrega una lista desplegable (<code>optional enum</code>) con las opciones de transformaci√≥n definidos en el script. Las opciones deben ir sin comillas y separadas por un punto y coma (;).</li>
<li>Agrega el par√°metro <code>output_plots_to_html</code> para desplegar la opci√≥n para guardar el gr√°fico R.</li>
</ul></li>
<li>Copia, pega y modifica el c√≥digo R en tu nuevo script.</li>
<li>Finalmente guarda tu script en el directorio de scripts definido en la configuraci√≥n del complemento.</li>
</ul>
{{% notice "warning" "ü§û Ayuda" %}}
El contenido a continuaci√≥n ha sido ocultado intencionalmente. Despli√©galo solo si sientes que no puedes realizar el ejercicio por tu cuenta.
{{% /notice %}}
<details style="margin-bottom:10px;">
<summary>
Haz clic para mostrar el contenido de ayuda.
</summary>
<pre class="r"><code>##Taller UseR!2022=group
##violinandboxplot=name
##Gr√°fico de violin y boxplot=display_name
##Capa=vector
##Campo=Field Capa
##Transform=optional enum boxcox;exp;log;log10;log1p;log2;logit;probability;probit;pseudo_log;reciprocal;reverse;sqrt
##output_plots_to_html

library(ggplot2)
if(!is.null(Transform)){
    Transform &lt;- c(&quot;boxcox&quot;, &quot;exp&quot;, &quot;log&quot;, &quot;log10&quot;, &quot;log1p&quot;, &quot;log2&quot;, 
               &quot;logit&quot;, &quot;probability&quot;, &quot;probit&quot;, &quot;pseudo_log&quot;, &quot;reciprocal&quot;, 
               &quot;reverse&quot;, &quot;sqrt&quot;)[Transform]
}
p &lt;- Capa |&gt; 
    ggplot() +
    geom_violin(aes_string(x = 0, y = Campo), 
                alpha = 0.3, fill = &quot;blue&quot;, width = 0.5) +
    geom_boxplot(aes_string(y = Campo), 
                 alpha = 0.5, fill = &quot;red&quot;, width = 0.1)

if(!is.null(Transform)) {
    p &lt;- p + 
        scale_y_continuous(trans = Transform) +
        labs(y = glue::glue(&quot;{Campo} [{Transform}]&quot;)) 
}
p</code></pre>
</details>
</div>
